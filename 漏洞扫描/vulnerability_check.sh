#!/bin/bash

echo "=== 本机漏洞检查脚本 ==="
echo "开始时间: $(date)"
echo "======================"
echo ""

VULN_DIR="./vulnerability_check_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$VULN_DIR"

# 颜色定义
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# 漏洞计数
CRITICAL_COUNT=0
HIGH_COUNT=0
MEDIUM_COUNT=0
LOW_COUNT=0

log_vulnerability() {
    local severity=$1
    local message=$2
    local file=$3
    
    case $severity in
        CRITICAL)
            echo -e "${RED}[严重]${NC} $message"
            ((CRITICAL_COUNT++))
            ;;
        HIGH)
            echo -e "${YELLOW}[高危]${NC} $message"
            ((HIGH_COUNT++))
            ;;
        MEDIUM)
            echo -e "${YELLOW}[中危]${NC} $message"
            ((MEDIUM_COUNT++))
            ;;
        LOW)
            echo "[低危] $message"
            ((LOW_COUNT++))
            ;;
    esac
    
    if [ -n "$file" ]; then
        echo "$message" >> "$file"
    fi
}

echo "[1] 检查系统更新和补丁..."
echo "----------------------------------------"
if command -v apt-get &> /dev/null; then
    echo "检测到Debian/Ubuntu系统"
    apt-get update &> /dev/null
    UPDATES=$(apt-get upgrade -s 2>/dev/null | grep -c "^Inst")
    if [ "$UPDATES" -gt 0 ]; then
        log_vulnerability "HIGH" "发现 $UPDATES 个可用更新，系统可能存在未修复漏洞" "$VULN_DIR/updates.txt"
        apt-get upgrade -s 2>/dev/null | grep "^Inst" > "$VULN_DIR/available_updates.txt"
    else
        echo -e "${GREEN}✓${NC} 系统已是最新版本"
    fi
elif command -v yum &> /dev/null; then
    echo "检测到CentOS/RHEL系统"
    UPDATES=$(yum check-update -q 2>/dev/null | grep -v "^$" | wc -l)
    if [ "$UPDATES" -gt 0 ]; then
        log_vulnerability "HIGH" "发现 $UPDATES 个可用更新" "$VULN_DIR/updates.txt"
        yum check-update > "$VULN_DIR/available_updates.txt" 2>&1
    else
        echo -e "${GREEN}✓${NC} 系统已是最新版本"
    fi
fi

echo ""
echo "[2] 检查危险端口开放情况..."
echo "----------------------------------------"
DANGEROUS_PORTS=(21 23 135 139 445 1433 3306 5432 3389 5900 6379 27017)
OPEN_PORTS=$(netstat -tuln 2>/dev/null | grep LISTEN | awk '{print $4}' | sed 's/.*://' | sort -u)

for port in "${DANGEROUS_PORTS[@]}"; do
    if echo "$OPEN_PORTS" | grep -q "^$port$"; then
        SERVICE=$(netstat -tuln 2>/dev/null | grep ":$port " | head -1)
        log_vulnerability "HIGH" "危险端口 $port 正在监听: $SERVICE" "$VULN_DIR/open_ports.txt"
    fi
done

# 检查所有开放端口
echo "$OPEN_PORTS" > "$VULN_DIR/all_open_ports.txt"
echo "所有开放端口已保存到: $VULN_DIR/all_open_ports.txt"

echo ""
echo "[3] 检查防火墙状态..."
echo "----------------------------------------"
if command -v ufw &> /dev/null; then
    UFW_STATUS=$(ufw status 2>/dev/null)
    if echo "$UFW_STATUS" | grep -q "Status: active"; then
        echo -e "${GREEN}✓${NC} UFW防火墙已启用"
    else
        log_vulnerability "HIGH" "UFW防火墙未启用" "$VULN_DIR/firewall.txt"
    fi
elif command -v firewall-cmd &> /dev/null; then
    if firewall-cmd --state 2>/dev/null | grep -q "running"; then
        echo -e "${GREEN}✓${NC} firewalld已启用"
    else
        log_vulnerability "HIGH" "firewalld未启用" "$VULN_DIR/firewall.txt"
    fi
elif command -v iptables &> /dev/null; then
    RULES=$(iptables -L -n 2>/dev/null | wc -l)
    if [ "$RULES" -lt 10 ]; then
        log_vulnerability "MEDIUM" "iptables规则较少，可能未正确配置" "$VULN_DIR/firewall.txt"
    else
        echo -e "${GREEN}✓${NC} iptables已配置"
    fi
else
    log_vulnerability "HIGH" "未检测到防火墙工具" "$VULN_DIR/firewall.txt"
fi

echo ""
echo "[4] 检查SSH配置安全..."
echo "----------------------------------------"
if [ -f /etc/ssh/sshd_config ]; then
    # 检查密码认证
    if grep -q "^PasswordAuthentication yes" /etc/ssh/sshd_config; then
        log_vulnerability "MEDIUM" "SSH允许密码认证，建议使用密钥认证" "$VULN_DIR/ssh_config.txt"
    fi
    
    # 检查Root登录
    if grep -q "^PermitRootLogin yes" /etc/ssh/sshd_config; then
        log_vulnerability "HIGH" "SSH允许Root直接登录" "$VULN_DIR/ssh_config.txt"
    fi
    
    # 检查空密码
    if grep -q "^PermitEmptyPasswords yes" /etc/ssh/sshd_config; then
        log_vulnerability "CRITICAL" "SSH允许空密码登录" "$VULN_DIR/ssh_config.txt"
    fi
    
    # 检查协议版本
    if grep -q "^Protocol 1" /etc/ssh/sshd_config; then
        log_vulnerability "CRITICAL" "SSH使用不安全的协议版本1" "$VULN_DIR/ssh_config.txt"
    fi
    
    # 检查空闲超时
    if ! grep -q "^ClientAliveInterval" /etc/ssh/sshd_config; then
        log_vulnerability "LOW" "SSH未设置客户端空闲超时" "$VULN_DIR/ssh_config.txt"
    fi
else
    log_vulnerability "MEDIUM" "未找到SSH配置文件" "$VULN_DIR/ssh_config.txt"
fi

echo ""
echo "[5] 检查弱密码和空密码账户..."
echo "----------------------------------------"
# 检查空密码账户
EMPTY_PASS=$(awk -F: '($2 == "" || $2 == "!") {print $1}' /etc/shadow 2>/dev/null)
if [ -n "$EMPTY_PASS" ]; then
    log_vulnerability "CRITICAL" "发现空密码账户: $EMPTY_PASS" "$VULN_DIR/weak_passwords.txt"
fi

# 检查UID为0的账户（除了root）
UID0_USERS=$(awk -F: '($3 == 0 && $1 != "root") {print $1}' /etc/passwd)
if [ -n "$UID0_USERS" ]; then
    log_vulnerability "CRITICAL" "发现其他UID为0的账户: $UID0_USERS" "$VULN_DIR/privilege_escalation.txt"
fi

# 检查可登录的账户
SHELL_USERS=$(awk -F: '($7 != "/usr/sbin/nologin" && $7 != "/bin/false" && $7 != "/sbin/nologin") {print $1}' /etc/passwd)
echo "可登录用户列表:" > "$VULN_DIR/login_users.txt"
echo "$SHELL_USERS" >> "$VULN_DIR/login_users.txt"

echo ""
echo "[6] 检查SUID/SGID危险文件..."
echo "----------------------------------------"
# 查找SUID文件
find /usr /bin /sbin /opt -type f -perm -4000 2>/dev/null > "$VULN_DIR/suid_files.txt"

# 检查危险的SUID程序
DANGEROUS_SUID=("find" "nmap" "vim" "nano" "less" "more" "awk" "sed" "cp" "mv")
for prog in "${DANGEROUS_SUID[@]}"; do
    if find /usr /bin /sbin -name "$prog" -perm -4000 2>/dev/null | grep -q .; then
        log_vulnerability "HIGH" "发现危险的SUID程序: $prog" "$VULN_DIR/suid_files.txt"
    fi
done

# 查找SGID文件
find /usr /bin /sbin /opt -type f -perm -2000 2>/dev/null > "$VULN_DIR/sgid_files.txt"

echo ""
echo "[7] 检查可写目录和文件权限..."
echo "----------------------------------------"
# 检查/etc目录下可写文件
find /etc -type f -writable 2>/dev/null > "$VULN_DIR/writable_etc_files.txt"
if [ -s "$VULN_DIR/writable_etc_files.txt" ]; then
    log_vulnerability "HIGH" "发现/etc目录下可写文件" "$VULN_DIR/writable_etc_files.txt"
fi

# 检查系统目录可写
for dir in /bin /sbin /usr/bin /usr/sbin /boot; do
    if [ -d "$dir" ] && [ -w "$dir" ]; then
        log_vulnerability "CRITICAL" "系统目录可写: $dir" "$VULN_DIR/writable_dirs.txt"
    fi
done

# 检查PATH中的可写目录
IFS=':' read -ra PATH_DIRS <<< "$PATH"
for dir in "${PATH_DIRS[@]}"; do
    if [ -d "$dir" ] && [ -w "$dir" ]; then
        log_vulnerability "CRITICAL" "PATH中的目录可写: $dir" "$VULN_DIR/writable_path.txt"
    fi
done

echo ""
echo "[8] 检查不必要的服务..."
echo "----------------------------------------"
if command -v systemctl &> /dev/null; then
    # 检查运行的服务
    systemctl list-units --type=service --state=running 2>/dev/null > "$VULN_DIR/running_services.txt"
    
    # 检查危险服务
    DANGEROUS_SERVICES=("telnet" "rsh" "rlogin" "rexec" "tftp" "xinetd")
    for svc in "${DANGEROUS_SERVICES[@]}"; do
        if systemctl is-active --quiet "$svc" 2>/dev/null; then
            log_vulnerability "HIGH" "危险服务正在运行: $svc" "$VULN_DIR/dangerous_services.txt"
        fi
    done
fi

echo ""
echo "[9] 检查默认凭据和弱配置..."
echo "----------------------------------------"
# 检查MySQL/MariaDB
if command -v mysql &> /dev/null; then
    if mysql -u root -e "SELECT 1" 2>/dev/null | grep -q "1"; then
        log_vulnerability "CRITICAL" "MySQL root账户可能使用空密码或弱密码" "$VULN_DIR/default_credentials.txt"
    fi
fi

# 检查Redis
if command -v redis-cli &> /dev/null; then
    if redis-cli ping 2>/dev/null | grep -q "PONG"; then
        CONFIG=$(redis-cli CONFIG GET requirepass 2>/dev/null)
        if echo "$CONFIG" | grep -q "requirepass.*\"\"" || ! echo "$CONFIG" | grep -q "requirepass"; then
            log_vulnerability "HIGH" "Redis未设置密码" "$VULN_DIR/default_credentials.txt"
        fi
    fi
fi

# 检查MongoDB
if command -v mongo &> /dev/null || command -v mongosh &> /dev/null; then
    if mongo --eval "db.version()" 2>/dev/null | grep -q "version" || mongosh --eval "db.version()" 2>/dev/null | grep -q "version"; then
        log_vulnerability "HIGH" "MongoDB可能未启用认证" "$VULN_DIR/default_credentials.txt"
    fi
fi

echo ""
echo "[10] 检查内核参数安全配置..."
echo "----------------------------------------"
# 检查IP转发
IP_FORWARD=$(sysctl -n net.ipv4.ip_forward 2>/dev/null)
if [ "$IP_FORWARD" = "1" ]; then
    log_vulnerability "MEDIUM" "IP转发已启用（如果不是路由器/网关，建议关闭）" "$VULN_DIR/kernel_params.txt"
fi

# 检查ICMP重定向
ICMP_REDIRECT=$(sysctl -n net.ipv4.conf.all.accept_redirects 2>/dev/null)
if [ "$ICMP_REDIRECT" = "1" ]; then
    log_vulnerability "MEDIUM" "接受ICMP重定向（安全风险）" "$VULN_DIR/kernel_params.txt"
fi

# 检查源路由
SOURCE_ROUTE=$(sysctl -n net.ipv4.conf.all.accept_source_route 2>/dev/null)
if [ "$SOURCE_ROUTE" = "1" ]; then
    log_vulnerability "MEDIUM" "接受源路由（安全风险）" "$VULN_DIR/kernel_params.txt"
fi

# 检查SYN cookies
SYN_COOKIES=$(sysctl -n net.ipv4.tcp_syncookies 2>/dev/null)
if [ "$SYN_COOKIES" != "1" ]; then
    log_vulnerability "MEDIUM" "SYN cookies未启用（可能遭受SYN flood攻击）" "$VULN_DIR/kernel_params.txt"
fi

echo ""
echo "[11] 检查日志配置..."
echo "----------------------------------------"
# 检查syslog服务
if command -v systemctl &> /dev/null; then
    if ! systemctl is-active --quiet rsyslog 2>/dev/null && ! systemctl is-active --quiet syslog-ng 2>/dev/null; then
        log_vulnerability "MEDIUM" "系统日志服务未运行" "$VULN_DIR/logging.txt"
    fi
fi

# 检查日志轮转
if [ ! -f /etc/logrotate.conf ]; then
    log_vulnerability "LOW" "未找到日志轮转配置" "$VULN_DIR/logging.txt"
fi

echo ""
echo "[12] 检查文件完整性（关键系统文件）..."
echo "----------------------------------------"
# 检查关键文件是否存在
CRITICAL_FILES=("/etc/passwd" "/etc/shadow" "/etc/group" "/etc/sudoers" "/etc/ssh/sshd_config")
for file in "${CRITICAL_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        log_vulnerability "CRITICAL" "关键系统文件缺失: $file" "$VULN_DIR/file_integrity.txt"
    elif [ ! -r "$file" ]; then
        log_vulnerability "HIGH" "关键系统文件不可读: $file" "$VULN_DIR/file_integrity.txt"
    fi
done

# 检查/etc/passwd和/etc/shadow的权限
if [ -f /etc/passwd ]; then
    PASSWD_PERM=$(stat -c "%a" /etc/passwd 2>/dev/null || stat -f "%OLp" /etc/passwd 2>/dev/null)
    if [ "$PASSWD_PERM" != "644" ]; then
        log_vulnerability "MEDIUM" "/etc/passwd权限异常: $PASSWD_PERM（应为644）" "$VULN_DIR/file_integrity.txt"
    fi
fi

if [ -f /etc/shadow ]; then
    SHADOW_PERM=$(stat -c "%a" /etc/shadow 2>/dev/null || stat -f "%OLp" /etc/shadow 2>/dev/null)
    if [ "$SHADOW_PERM" != "640" ] && [ "$SHADOW_PERM" != "600" ]; then
        log_vulnerability "HIGH" "/etc/shadow权限异常: $SHADOW_PERM（应为640或600）" "$VULN_DIR/file_integrity.txt"
    fi
fi

echo ""
echo "[13] 检查定时任务..."
echo "----------------------------------------"
# 检查root的crontab
if [ -f /var/spool/cron/crontabs/root ] || [ -f /var/spool/cron/root ]; then
    echo "Root用户的定时任务:" > "$VULN_DIR/crontab.txt"
    crontab -l -u root 2>/dev/null >> "$VULN_DIR/crontab.txt"
fi

# 检查/etc/crontab
if [ -f /etc/crontab ]; then
    echo -e "\n系统定时任务 (/etc/crontab):" >> "$VULN_DIR/crontab.txt"
    cat /etc/crontab >> "$VULN_DIR/crontab.txt"
fi

# 检查/etc/cron.d
if [ -d /etc/cron.d ]; then
    echo -e "\n/etc/cron.d 目录内容:" >> "$VULN_DIR/crontab.txt"
    ls -la /etc/cron.d >> "$VULN_DIR/crontab.txt"
fi

# 检查可疑的定时任务
if [ -f "$VULN_DIR/crontab.txt" ]; then
    if grep -E "(wget|curl|bash -i|sh -i|nc |netcat|perl|python.*http)" "$VULN_DIR/crontab.txt" 2>/dev/null; then
        log_vulnerability "CRITICAL" "发现可疑的定时任务（可能包含后门）" "$VULN_DIR/suspicious_crontab.txt"
    fi
fi

echo ""
echo "[14] 检查环境变量安全..."
echo "----------------------------------------"
# 检查PATH环境变量
if echo "$PATH" | grep -q "::"; then
    log_vulnerability "MEDIUM" "PATH环境变量包含空目录（安全风险）" "$VULN_DIR/env_vars.txt"
fi

# 检查危险的环境变量
if [ -n "$LD_PRELOAD" ]; then
    log_vulnerability "HIGH" "LD_PRELOAD环境变量已设置: $LD_PRELOAD" "$VULN_DIR/env_vars.txt"
fi

if [ -n "$LD_LIBRARY_PATH" ] && echo "$LD_LIBRARY_PATH" | grep -q "\.\|:"; then
    log_vulnerability "MEDIUM" "LD_LIBRARY_PATH包含当前目录或相对路径" "$VULN_DIR/env_vars.txt"
fi

echo ""
echo "[15] 生成漏洞汇总报告..."
echo "========================================"
REPORT_FILE="$VULN_DIR/vulnerability_report.txt"
{
    echo "漏洞检查报告"
    echo "生成时间: $(date)"
    echo "========================================"
    echo ""
    echo "漏洞统计:"
    echo "  严重漏洞: $CRITICAL_COUNT"
    echo "  高危漏洞: $HIGH_COUNT"
    echo "  中危漏洞: $MEDIUM_COUNT"
    echo "  低危漏洞: $LOW_COUNT"
    echo "  总计: $((CRITICAL_COUNT + HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))"
    echo ""
    echo "========================================"
    echo ""
    echo "详细检查结果请查看 $VULN_DIR/ 目录下的各个文件"
} > "$REPORT_FILE"

cat "$REPORT_FILE"

echo ""
echo "========================================"
echo "漏洞检查完成！"
echo "所有结果已保存到: $VULN_DIR/"
echo "========================================"
echo ""
echo "【修复建议优先级】"
echo "1. 立即修复严重漏洞（CRITICAL）"
echo "2. 尽快修复高危漏洞（HIGH）"
echo "3. 计划修复中危漏洞（MEDIUM）"
echo "4. 评估低危漏洞（LOW）"
echo ""
echo "【查看详细报告】"
echo "cat $REPORT_FILE"
echo "========================================"


